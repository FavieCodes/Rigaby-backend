[build]
  command = "npm run build:netlify && npm run prisma:copy-netlify"
  functions = "netlify/functions"
  publish = "dist"

[build.environment]
  NODE_VERSION = "18"
  NODE_ENV = "production"
  NODE_OPTIONS = "--max-old-space-size=4096"

# Development server
[dev]
  command = "npm run start:dev"
  port = 3005
  publish = "dist"

# API redirects
[[redirects]]
  from = "/api/*"
  to = "/.netlify/functions/api/:splat"
  status = 200

# Root redirect for SPA
[[redirects]]
  from = "/*"
  to = "/.netlify/functions/api/:splat"
  status = 200

[functions]
  node_bundler = "esbuild"
  
  # Externalize problematic modules
  external_node_modules = [
    "@prisma/client",
    "@prisma/engines",
    "prisma",
    "class-transformer/storage",
    "@grpc/grpc-js",
    "@grpc/proto-loader",
    "kafkajs",
    "mqtt",
    "ioredis",
    "nats",
    "amqplib",
    "amqp-connection-manager",
    "@nestjs/microservices",
    "@nestjs/websockets",
    "@nestjs/platform-socket.io"
  ]
  
  included_files = [
    "node_modules/.prisma/**/*",
    "node_modules/@prisma/client/**/*",
    "node_modules/@prisma/engines/**/*",
    "prisma/schema.prisma"
  ]

# Function-specific configuration for API function
[[functions]]
  path = "netlify/functions/api.ts"
  node_bundler = "esbuild"
  
  # Increase timeout for Nest.js cold starts
  timeout = 30
  
  external_node_modules = [
    "@prisma/client",
    "@prisma/engines",
    "prisma",
    "class-transformer/storage",
    "@grpc/grpc-js",
    "@grpc/proto-loader",
    "kafkajs",
    "mqtt",
    "ioredis",
    "nats",
    "amqplib",
    "amqp-connection-manager",
    "@nestjs/microservices",
    "@nestjs/websockets",
    "@nestjs/platform-socket.io"
  ]
  
  included_files = [
    "node_modules/.prisma/**/*",
    "node_modules/@prisma/client/**/*",
    "node_modules/@prisma/engines/**/*",
    "prisma/schema.prisma"
  ]
